## 🚀 プロジェクト開発環境ドキュメント

このドキュメントは、`3d_tennis_lab` プロジェクトの開発環境を構築・利用するための手順を説明します。プロジェクトでは **Docker** と **Docker Compose** を使用し、誰でも同じ構成で再現可能な開発環境を簡単に構築できるようにしています。

### **全体構成**

この開発環境は、以下の3つの主要なファイルによって定義されています。

1.  **`pyproject.toml`**: Pythonプロジェクトの依存関係（`torch`, `pandas`など）や、コードフォーマッター（`ruff`）、型チェッカー（`mypy`）などの開発ツール設定を **Poetry** を使って管理します。
2.  **`docker/Dockerfile`**: プロジェクトの実行に必要なPythonのバージョン、システムライブラリ、そして`pyproject.toml`に定義された全てのPythonパッケージを含むDockerイメージを構築するための設計図です。
3.  **`docker-compose.yml`**: `Dockerfile`からイメージをビルドし、ポートフォワーディングやボリュームマウント（ホストマシンとコンテナ間でのファイル共有）などの設定を定義して、実際にコンテナとしてサービス（`dev`）を起動するための指示書です。

-----

### **🛠️ 各ファイルの詳細**

#### **1. `pyproject.toml`**

このファイルは、プロジェクトの心臓部であり、Poetryによって利用されます。

  * **[tool.poetry]**: プロジェクト名、バージョン、説明などの基本情報を定義します。
  * **[tool.poetry.dependencies]**: プロジェクトの実行に**必須**のライブラリ（`torch`, `pytorch-lightning`, `opencv-python`, `jupyterlab`など）を定義します。Pythonのバージョンは`3.11`系に固定されています。
  * **[tool.poetry.group.dev.dependencies]**: 開発時にのみ使用するツール（テスト用の`pytest`や静的解析の`mypy`など）を定義します。これらは本番環境のイメージには含まれず、開発の効率化を目的としています。
  * **[tool.ruff], [tool.mypy]など**: コードの品質を保つためのリンターやフォーマッターの設定です。これにより、チーム内でのコーディングスタイルが統一されます。

#### **2. `docker/Dockerfile`**

このファイルは、開発環境となるDockerイメージを作成するための手順書です。

  * `FROM python:3.11-slim`: 公式の軽量なPython 3.11イメージをベースとして使用します。
  * `WORKDIR /app`: コンテナ内の作業ディレクトリを`/app`に設定します。
  * `RUN apt-get update && ...`: `git`や`curl`など、Pythonライブラリのインストールに必要なシステムパッケージを導入します。
  * `RUN pip install "poetry==1.8.2"`: プロジェクトで使うPoetryのバージョンを固定し、環境の再現性を高めます。
  * `COPY poetry.lock pyproject.toml /app/`: **Dockerのキャッシュを有効活用する**ための重要なステップです。依存関係ファイルだけを先にコピーすることで、ソースコードの変更時に毎回パッケージを再インストールする無駄を省きます。
  * `RUN poetry config virtualenvs.create false && poetry install ...`: Poetryの設定で仮想環境を作成しないようにし（コンテナ自体が隔離環境のため）、`pyproject.toml`に記載された全ての依存関係をインストールします。
  * `EXPOSE 8888`: コンテナが8888番ポートを利用することを宣言します。
  * `CMD ["poetry", "run", "jupyter", "lab", ... ]`: コンテナ起動時にデフォルトで実行されるコマンドです。JupyterLabサーバーを起動し、外部からアクセスできるようにします。

#### **3. `docker-compose.yml`**

このファイルは、開発環境（`dev`サービス）の起動方法を定義するオーケストレーターです。

  * `build:`:
      * `context: ..`: Dockerイメージをビルドする際の基準ディレクトリをプロジェクトルート（`docker-compose.yml`から見て一つ上の階層）に設定します。これにより、`Dockerfile`がプロジェクト内の`pyproject.toml`などを参照できます。
      * `dockerfile: docker/Dockerfile`: 使用するDockerfileのパスを指定します。
  * `ports: - "8888:8888"`: **ホストマシン（あなたのPC）の8888番ポート**を、**コンテナの8888番ポート**に接続します。これにより、あなたのPCのブラウザからコンテナ内のJupyterLabにアクセスできます。
  * `volumes:`:
      * `- ..:/app`: **最も重要な設定の一つです。** ホストマシンのプロジェクトルートディレクトリ全体を、コンテナの`/app`ディレクトリにマウント（同期）します。これにより、**ホストマシンでソースコードを編集すると、それが即座にコンテナ内に反映されます。** イメージを再ビルドする必要はありません。
      * `- ../data:/app/data`: データファイルを格納する`data`ディレクトリも同様にマウントします。これにより、コンテナを破棄してもデータが失われません。
  * `tty: true`: コンテナの標準入出力を開いたままにし、コンテナが意図せず終了するのを防ぎます。

-----

### **📚 使用方法**

#### **前提条件**

  * Docker
  * Docker Compose

上記がお使いのPCにインストールされている必要があります。

#### **1. 環境のビルドと起動**

プロジェクトのルートディレクトリ（`docker-compose.yml`がある場所の親ディレクトリ）で、以下のコマンドを実行します。

```bash
# -d: バックグラウンドで起動
# --build: 初回起動時やDockerfileに変更があった場合にイメージを再ビルド
docker compose up -d --build
```

#### **2. JupyterLabへのアクセス**

起動後、お使いのWebブラウザで以下のURLにアクセスしてください。

➡️ **http://localhost:8888**

初回アクセス時には、ターミナルに表示されるログからトークンをコピーして入力する必要があります。

```bash
# ログを確認してトークンを探す
docker compose logs dev
```

#### **3. コンテナ内でのコマンド実行**

JupyterLab以外にも、コンテナ内で直接コマンドを実行したい場合があります。例えば、ターミナル（bash）を起動するには以下のコマンドを実行します。

```bash
docker compose exec dev bash
```

これにより、必要なライブラリが全てインストールされたコンテナの環境内で、直接コマンド操作ができます。

#### **4. 環境の停止**

開発を終了する際は、以下のコマンドでコンテナを停止・削除します。

```bash
# ボリュームは削除されません
docker compose down
```