# プロジェクト計画書：3Dテニス自動解析システム

## 1. プロジェクト概要 (Project Overview)

本プロジェクトは、テニスの試合映像を自動で解析し、コート、プレーヤー、ボールの動きを**3次元情報**として捉える革新的なシステムを開発することを目的とします。抽出した3Dデータに基づき、戦術的なイベント検出や統計分析を行い、最終的には試合内容を言語化するAIの構築を目指します。

## 2. システムアーキテクチャ

本システムは、複数のモジュールが連携するパイプライン構成を取ります。**各工程内では、複数の機能を単一モデルに統合することで、効率的かつ高精度な解析を目指します。**

**入力 (Input):** テニスの試合映像

1.  **上流工程：3D情報抽出 (Upstream: 3D Information Extraction)**
    *   映像から「コート」「プレーヤー」「ボール」の3D座標と姿勢を時系列で推定します。
2.  **下流工程：イベント検出 (Downstream: Event Detection)**
    *   抽出した3D情報を用いて、「サーブ」「ラリー」「ショット」「ポイント獲得」などの試合イベントを**単一のマルチタスクモデル**で認識します。
3.  **統合解析システム (Integrated Analysis System)**
    *   全ての情報を統合し、試合全体の統計データ（サーブ成功率、ラリー数、ウィナー数など）をロバストに算出・可視化します。
4.  **将来展望：LLMによる言語化 (Future: LLM-based Generation)**
    *   解析結果を大規模言語モデル（LLM）に入力し、試合の要約や戦術解説を自動生成します。

---

## 3. 主要技術要素と開発方針

### 3.1. 上流工程：3D情報抽出

#### 3.1.1. コート姿勢推定 (Court Pose Estimation)
*   **目的:** コート中心を原点(0,0,0)とした、カメラの6DoFポーズ（3次元並進＋3次元回転）をフレーム毎に推定します。
*   **学習手法:**
    1.  テニスコートの3Dモデル（ラインの座標など）を定義します。
    2.  推定したカメラポーズを用いて、3Dモデルを2D画像平面に投影します。
    3.  投影された2Dラインと、正解アノテーション（映像上のコートラインのキーポイント）との誤差を損失関数とし、モデルを学習させます。

#### 3.1.2. プレーヤー解析 (Player Analysis)
*   **目的:** プレーヤーの3D姿勢、位置、形状を推定します。
*   **採用技術:** **Humans4D** を活用し、高精度な人体3Dメッシュの復元を目指します。

#### 3.1.3. ボール追跡 (Ball Tracking)
*   **目的:** ボールの3D軌道を高精度に追跡します。特にオクルージョンに強いモデルを目指します。
*   **モデル構成と戦略:**
    *   **アプローチ1（ベースライン）:** 「検出 -> 追跡」の2段階パイプラインを構築します。まずフレーム毎にボールを検出し、その後に別モデルで時間的に関連付け（トラッキング）を行います。
    *   **アプローチ2（統合モデル）:** **検出と追跡の機能を1つのモデルに統合します。** これにより、モデルの複雑さを軽減し、推論を高速化する可能性があります。
    *   **アプローチ3（先進的アプローチ）:** **モデル自体に時系列理解能力を持たせ、検出とトラッキングをエンドツーエンドで同時に実行するアーキテクチャを検討します。** 例えば、Transformerベースのモデルは、フレーム間の関係性を直接学習できるため、このアプローチに適しています。これにより、オクルージョンからの復帰やIDスイッチの抑制など、より高度な追跡性能が期待できます。
*   **学習手法:**
    *   （変更なし）コートと同様に、3D軌道を2Dに投影し、2Dの正解キーポイントとの誤差から学習信号を与えます。
    *   （変更なし）**Humans4D**のアーキテクチャを参考に、時系列情報から隠れた部分の情報を予測・補完する**BERTのような自己教師あり学習**アプローチを導入します。

### 3.2. 下流工程：イベント検出

抽出した3D時系列データから、より高次の意味情報（＝イベント）を抽出します。

*   **目的:** プレーヤーの位置関係、ボールの軌道、速度などから「サーブ」「ストローク」「ボレー」「スマッシュ」といった複数のイベントを時系列で検出します。
*   **モデル方針:** **単一の統合モデルによるマルチタスク学習 (Multi-task Learning) を採用します。**
    *   1つのモデルが、複数のイベント検出タスク（例: `is_serve`, `is_rally`, `shot_type` など）を同時に学習・推論します。
    *   **利点:**
        *   **性能向上:** あるタスクの学習が、他の関連タスクの学習を助ける「正則化」として機能し、モデル全体の汎化性能が向上します。
        *   **効率化:** モデルが1つに集約されるため、開発・管理コストが削減されます。
*   **課題とデータセット構築:**
    *   （変更なし）本タスクのためのアノテーション付きデータセットが存在しないため、新規に構築する必要があります。
    *   （変更なし）アノテーションコストを最小化するため、**自己教師あり学習 (Self-Supervised Learning)** や**半教師あり学習 (Semi-Supervised Learning)** の導入を積極的に検討します。
*   **検討モデル:**
    *   **Transformer系モデル / GNN:** これらのアーキテクチャは、オブジェクト間の複雑な時空間的関係性を捉える能力に長けており、**マルチタスクの出力ヘッドを容易に設計できる**ため、本方針に適しています。
### 3.3. 統合解析システム

*   **目的:** 上流・下流で得られた全情報を集約し、試合全体の統計情報を正確に算出するシステムを構築します。
*   **要件:**
    *   **ロバスト性:** 一部のモジュールでエラーが発生しても、システム全体が破綻しない堅牢な設計。
    *   **スケーラビリティ:** 長時間の試合データや多数の試合データを効率的に処理できる、大規模設計を視野に入れます。
    *   APIやダッシュボードを提供し、解析結果を外部から利用・可視化できるようにします。

---

## 4. 将来展望：LLMとの連携

本プロジェクトの最終的な発展形として、解析結果の言語化を目指します。

*   **目的:** 算出された統計データやイベント時系列をLLMに入力し、人間が読むような自然な試合解説や戦術分析レポートを自動生成します。
*   **開発戦略:**
    *   **資金的制約への対応:** 学生という立場上、大規模な計算資源の確保が難しいため、**小規模なモデルのファインチューニング（FT）**や、PEFT (Parameter-Efficient Fine-Tuning) などの低コストな学習手法を中心に研究・開発を進めます。
    *   **技術動向の追随:** LLM分野の発展は非常に速いため、開発時点での最新かつ高性能なモデル、効率的なFT戦略を柔軟に取り入れていく方針です。

## 5. プロジェクト構造の概要

提示されたファイルツリーに基づき、主要なディレクトリの役割を以下に定めます。

| ディレクトリ/ファイル   | 役割                                                                 |
| ----------------------- | -------------------------------------------------------------------- |
| `3d_tennis_system`      | **完成したモデル群を統合**し、システム全体の推論パイプラインを構築する場所。再利用可能なデータセット定義や共通ユーティリティも含む。 |
| `development`           | コンポーネントごと（コート、選手、ボール等）のモデル開発と試行錯誤の場 |
| `trained_models`        | 開発を経て選抜された、学習済みのモデル、設定、ログ等を格納する場所   |
| `notebooks`             | データ分析、可視化、モデルの試作のためのJupyter Notebook             |
| `configs`               | モデル、学習、データ処理に関する設定ファイル（YAML, TOML等）           |
| `data`                  | 元となる動画データ、アノテーションデータ、中間生成物                   |
| `scripts`               | 学習の実行、推論、データ前処理などのためのユーティリティスクリプト       |
| `tools`                 | アノテーション生成など、開発を補助するユーティリティを配置する場所     |
| `tests`                 | コードの品質を保証するための単体テスト・結合テスト                     |
| `docker` / `.devcontainer` | 再現可能な開発・実行環境を定義するDocker関連ファイル                 |
| `pyproject.toml`        | プロジェクトの依存関係とメタ情報を管理 (Poetry)                      |
| `README.md`             | プロジェクトの概要と使い方を記述するドキュメント（この文書など）       |
