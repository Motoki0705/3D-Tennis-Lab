# フェーズ0：基盤（論理スキーマ／契約／バージョニング）

## 目的

I/O・Bundling・Pipeline を疎結合に保つための**共通契約**を確立し、長期運用の再現性と拡張性を担保する。

## 要件

- **論理スキーマ（Logical Schema）**

  - エンティティ：`FrameObs` / `Bundle` / `Result`
  - 各フィールドの意味・単位・必須/任意・値域・整合性制約を明文化（例：`keypoints` は px、`court3d` は m、可視点≥4）。
  - 参照整合：`keypoints` のキー集合は `court3d` のキー集合に包含。

- **スキーマ・実装のバージョニング**

  - `schema_version`（例：`frameobs@1.0.0`、`bundle@1.0.0`、`result@1.0.0`）を**常に出力**。
  - `pipeline_version` と `stage_versions` を結果に記録（実装変更の追跡）。
  - 互換ポリシー：minor＝後方互換、major＝破壊的変更。必要に応じてマイグレーション規約を定義。

- **ステージ契約（Stage Contract）**

  - 各Stageは **`required_inputs` / `produces`** をメタデータとして宣言。
  - 実行前に**前提条件チェック**、実行後に**後条件検証**を自動実施。違反時は明確なエラーと修復ガイダンスを出す。

**受け入れ条件**

- 任意の結果ファイルに `schema_version`・`pipeline_version`・`stage_versions` が必ず含まれる。
- 契約違反（例：可視点<4、K不在）は、ステージ開始前に検出され、停止またはスキップ判定が行われる。

---

# フェーズ1：I/O正規化（アダプタ）とバンドリング（束決定）

## 目的

入力形式の差（COCO/JSONL/将来形式）と束の切り方を、**宣言的設定**で切り替え可能に。

## 要件

- **I/Oアダプタ**

  - `format ∈ {coco, jsonl, custom}` を受け、**`FrameObs[]` に正規化**。
  - COCOのとき：

    - `images/annotations/categories` を解釈、`keypoint_map` で内部キーへ正規化。
    - 複数アノテ時の選択方針（先頭／スコア最大）を設定化。
    - `min_visible` による可視判定、重み `w` のポリシー（固定値／スコア利用）の設定化。
    - パスは POSIX 正規化、画像サイズは `meta.width/height` に格納。

  - 形式不正・欠落は**収集して警告**、クリティカルで停止（ポリシー化）。

- **Bundler（戦略プラグイン）**

  - 戦略：`by_prefix`（正規表現/区切り）、`by_meta`（camera_id）、`by_fn`（ユーザ定義）。
  - 出力：`{bundle_id -> Bundle}`（`frames` と共有Kの初期値を含む）。
  - **共有Kの粒度選択**：`by_bundle` / `by_scene` / `global` を設定で指定。
  - 混在検出：1束に複数prefix/Kが混じる場合は自動分割or警告。

**受け入れ条件**

- 同一実行で、`Dimitrov_`/`Nadal_` 等の複数束を**自動分割**し、束ごとに処理が走る。
- `by_bundle`・`by_scene`・`global` の切替で、共有Kの粒度が期待どおりに変わる。

---

# フェーズ2：DAG実行エンジン（分岐・並列・差分）

## 目的

固定の直列パイプラインを超え、**依存関係ベース**で柔軟に実行・スキップ・並列化・再実行最小化を実現。

## 要件

- **依存の宣言**：各Stageは依存キー（`required_inputs`）に基づき DAG のノードとして配置される。
- **トポロジカル実行**：依存が満たされたノードから実行。独立ノードは**並列**可。
- **条件分岐**：依存が満たされない枝（例：K既知で `estimate_k` 不要）は**自動スキップ**。
- **キャッシュ**：ノードの**入力（データ/設定/実装版）ハッシュ**で中間成果をキャッシュ。変更が無い枝は**差分スキップ**。
- **失敗の局所化**：失敗ノード以降のみ停止。別枝・別Bundleには波及させない。

**受け入れ条件**

- Kが既知の実行では `estimate_k` 枝が自動的にスキップされる。
- 同一入力・設定・コードの再実行で、**中間キャッシュ**が活用され、実行量が減る。

---

# フェーズ3：推定・最適化（プラグイン化 & 段階解放）

## 目的

最適化バックエンドや誤差項・カメラモデルを**差し替え可能**にし、段階的にパラメータを解放できる柔軟性を確保。

## 要件

- **最適化バックエンドのプラグイン**

  - `opencv` / `scipy`（将来：Ceres/自動微分 など）を切替可能。
  - バックエンドごとの**機能差**（ロバスト損失、制約、ヤコビアン）を契約として明記。

- **段階解放スケジュール**

  - 共有K前提で `Rt → (fx,fy) → (cx,cy) → dist` を**宣言的に制御**。
  - ステップごとに**上限反復・ロス関数・バウンド・事前**を設定可能。

- **誤差項のプラグイン**

  - 点の再投影誤差に加え、**ライン距離／消失点制約／地面平面制約**等を**組み合わせ可能**。
  - 各誤差項は**有効/無効**とハイパラを設定で制御。

- **カメラモデルのプラグイン**

  - 歪みモデル（Brown-Conrady、Fisheye等）や投影モデル（ピンホール、全方位）を選択可能。

**受け入れ条件**

- バックエンド・誤差項・スケジュールの切替が**設定のみ**で可能。
- 段階解放により、RMSEの**単調改善**または許容レンジ内の改善が確認できる。

---

# フェーズ4：可観測性（メトリクス標準化・監査）

## 目的

“結果”だけでなく“どう良くなったか”を見える化し、再現・監査・品質管理を容易にする。

## 要件

- **`report.metrics` の標準化**

  - **再投影誤差の分布**：平均、標準偏差、分位点（P50/P90/P95/P99）、**ヒストグラム**（ビン幅・範囲は設定化）。
  - **姿勢の幾何健全性**：光軸とコート法線角度、t.z（カメラ高さ）と期待範囲との偏差。
  - **反復ログ**：RANSACの内点率履歴、BA/LM のコスト・RMSEの反復履歴（要約＋サンプル）。
  - **内外判定**：最終 inlier 比率、マスクの要約（連番・クラスタ性などは任意）。

- **可視化成果**：観測○/投影×、inlier/outlier色分け、代表フレームの保存（全件化は設定で制御）。
- **トレーサビリティ**：設定スナップショット、乱数種、依存バージョン、実行環境（OS/CPU/GPU）を結果に埋め込む。

**受け入れ条件**

- すべての結果に `report.metrics` が存在し、上記項目が埋まる。
- 代表的な案件で、ヒスト・分位点・反復ログが**期待どおりに更新**されること。

---

# フェーズ5：エクスポート／互換・連携

## 目的

外部システムから扱いやすい成果物（YAML/NPZ等）を安定提供し、将来の互換を維持。

## 要件

- **成果物**

  - YAML（人間可読）：共有K、各(R,t)、`report.metrics`、`schema/pipeline/stage_versions`、警告一覧、入出力パス。
  - NPZ（機械可読）：`K, dist, poses[], residuals_last, inlier_mask_last`（配列・型の契約を固定）。

- **互換**

  - major/minor の互換方針に従い、**読み手**が対応バージョン外の場合は明確にエラー。
  - 必要に応じて**マイグレータ**（旧→新／新→旧）を用意。

- **連携**

  - 外部API用の安定インタフェース（“`FrameObs[]` → `{bundle_id: Result}`”）を公開契約として記述。

**受け入れ条件**

- 他プロセス／他言語から、YAML/NPZを契約通りに読み出せる。
- 旧バージョン結果の取り込みに、互換ガイドラインどおりの動作（エラー／自動移行）が起きる。

---

# フェーズ6：品質保証（テスト／DQ／レギュレーション）

## 目的

拡張を続けても壊れないよう、**共通テストスイート**とデータ品質チェックを制度化。

## 要件

- **契約テスト**：各Stageの `required_inputs` / `produces` を自動検証。
- **生成テスト**：合成データで RMSE 低減、K/姿勢の収束、メトリクス妥当性を継続検証。
- **回帰テスト**：代表データで主要指標の許容レンジを固定し、逸脱を検知。
- **DQ（Data Quality）**：点の分布、可視点数、NaN/範囲外、外れ値比率を**事前スクリーニング**し、束から除外 or 重み低減。
- **セーフデフォルト**：RANSAC閾値、Kのバウンド、姿勢事前（ロール/ピッチ/高さ）などの既定値を文書化。

**受け入れ条件**

- 主要PR／リリースでテストが自動実行され、契約破りや劣化が検出される。
- 低品質データの投入時、明確な理由とともに**自動遮断または減衰**される。

---

# フェーズ7：運用・拡張ガバナンス（任意）

## 目的

大規模運用・協調開発での安定性を高める。

## 要件

- **プロファイル**：`debug / standard / robust` 等の実行プロファイルを定義（Viz量・反復上限・ロバスト度合い）。
- **実行モード**：単機／並列／分散の切替を同一契約で提供。中間成果のキャッシュ再利用と再試行ルールを明文化。
- **プラグイン・レジストリ**：I/O・Bundler・バックエンド・誤差項・カメラモデルを**登録/発見**できる仕組み（名称・説明・互換範囲のメタ情報を含む）。

**受け入れ条件**

- プロファイル切替で同じ入力に対し**再現可能な差**（速度/精度）が得られる。
- 新プラグインの追加が**契約の追加登録だけ**で可能。

---

## まとめ（採用項目の位置づけ）

- **型＆スキーマ固定＋バージョン付**：フェーズ0のコア。以降の全フェーズの土台。
- **Stage契約と前後条件検証**：フェーズ0/2でDAGに密接。早期検知で壊れにくく。
- **Bundler戦略（by_prefix/by_meta/by_fn）**：フェーズ1で差し替え可能に。
- **共有K粒度（by_bundle/by_scene/global）**：フェーズ1の設定で選択。
- **DAG導入**：フェーズ2で分岐・並列・差分実行・キャッシュ。
- **プラグイン拡張点**：フェーズ3/7で最適化・誤差・カメラモデル・I/Oを横展開。
- **メトリクス標準化**：フェーズ4で `report.metrics` を規格化（誤差分布・姿勢健全性・反復ログ）。
